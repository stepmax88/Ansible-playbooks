---
- name: "Powering on DELL and send Telegram"
  block:
    - name: "Powering on DELL {{ item }}"
      dellemc.openmanage.redfish_powerstate:
        baseuri: "{{ item }}:443"
        username: "{{ lookup('hashi_vault', '<path>/idrac:username') }}"
        password: "{{ lookup('hashi_vault', '<path>/idrac:password') }}"
        reset_type: "On"
        validate_certs: false
      when:
        - ansible_date_time.weekday in ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"]
        - ansible_date_time.hour | int >= 8
        - ansible_date_time.hour | int < 19
      failed_when: false
      register: task_power_idrac
    - name: "Save for handler"
      set_fact:
        tg_msg: "Send power on {{ item }}"
      notify: "Send notify on Telegram"
      failed_when: false
      changed_when: true
      when: task_power_idrac.changed
  when:
    - item in idrac_host
    - (idrac_host | default([]) | length > 0)
  rescue:
    - name: "Save for handler"
      set_fact:
        tg_msg: "ERROR: power on {{ item }}"
    - name: "Send error notify on Telegram"
      telegram:
        token: '{{ telegram.token }}'
        api_args:
          chat_id: "{{ telegram.chat_id }}"
          parse_mode: "markdown"
          text: "{{ tg_msg }}"
          disable_web_page_preview: true
          disable_notification: false

- name: "Powering on SUPERMICRO and send Telegram"
  block:
    - name: "Powering on SUPERMICRO {{ item }}"
      ipmi_power:
        name: "{{ item }}"
        user: "{{ lookup('hashi_vault', '<path>/ipmi:user') }}"
        password: "{{ lookup('hashi_vault', '<path>/ipmi:password') }}"
        state: on
      delegate_to: localhost
      failed_when: false
      when:
        - ansible_date_time.weekday in ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"]
        - ansible_date_time.hour | int >= 8
        - ansible_date_time.hour | int < 19
      register: task_power_ipmi
    - name: "Save for handler"
      set_fact:
        tg_msg: "Send power on {{ item }}"
      notify: "Send notify on Telegram"
      changed_when: true
      when: task_power_ipmi.changed
      failed_when: false
  when:
    - item in ipmi_host
    - (ipmi_host | default([]) | length > 0)
  rescue:
    - name: "Save for handler"
      set_fact:
        tg_msg: "ERROR: power on {{ item }}"
    - name: "Send error notify on Telegram"
      telegram:
        token: '{{ telegram.token }}'
        api_args:
          chat_id: "{{ telegram.chat_id }}"
          parse_mode: "markdown"
          text: "{{ tg_msg }}"
          disable_web_page_preview: true
          disable_notification: false

- meta: flush_handlers

- name: Accumulate results for report
  set_fact:
    execution_log: "{{ execution_log | default([]) + [{
        'item': item,
        'idrac_res': task_power_idrac | default({'skipped': true}),
        'ipmi_res': task_power_ipmi | default({'skipped': true})
      }] }}"
  delegate_to: localhost