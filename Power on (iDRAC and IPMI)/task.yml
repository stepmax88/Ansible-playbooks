---
- name: "Powering on DELL and send Telegram"
  block:
    - name: "Check if iDRAC Redfish port 443 is reachable"
      wait_for:
        host: "{{ item }}"
        port: 443
        state: started
        timeout: 5
      delegate_to: localhost
      register: idrac_port_check

    - name: "Powering on DELL {{ item }}"
      dellemc.openmanage.redfish_powerstate:
        baseuri: "{{ item }}:443"
        username: "{{ lookup('hashi_vault', '<path>:username') }}"
        password: "{{ lookup('hashi_vault', '<path>/idrac:password') }}"
        reset_type: "On"
        validate_certs: false
      register: task_power_idrac
    - name: "Save for handler"
      set_fact:
        tg_msg: "Send power on {{ item }}"
      notify: "Send notify on Telegram"
      changed_when: true
      when: task_power_idrac.changed
  when:
    - item in (idrac_host | default([], true))
    - (idrac_host | default([], true) | length > 0)
  rescue:
    - name: "Save for handler error"
      set_fact:
        tg_msg: |
          ❌ ERROR: Failed to power on DELL {{ item }}.
          Status: {{ 'Network unreachable (Port 443)' if (idrac_port_check.failed | default(false)) else 'Redfish Module error' }}
      notify: "Send notify on Telegram"
      changed_when: true

- name: "Powering on SUPERMICRO and send Telegram"
  block:
    - name: "Check if IPMI port 623 is reachable for {{ item }}"
      wait_for:
        host: "{{ item }}"
        port: 623
        state: started
        delay: 0
        timeout: 5
      delegate_to: localhost
      register: port_check
    - name: "Powering on SUPERMICRO {{ item }}"
      ipmi_power:
        name: "{{ item }}"
        user: "{{ lookup('hashi_vault', '<path>/ipmi:user') }}"
        password: "{{ lookup('hashi_vault', '<path>/ipmi:password') }}"
        state: on
      delegate_to: localhost
      register: task_power_ipmi
      when: port_check.failed is not defined or not port_check.failed
    - name: "Save for handler"
      set_fact:
        tg_msg: "Send power on {{ item }}"
      notify: "Send notify on Telegram"
      changed_when: true
      when: task_power_ipmi.changed
  when:
    - item in (ipmi_host | default([], true))
    - (ipmi_host | default([], true) | length > 0)
  rescue:
    - name: "Save for handler error"
      set_fact:
        tg_msg: >
          ❌ ERROR: Failed to power on {{ item }}.
          Status: {{ 'Network unreachable (Port 623)' if (port_check.failed | default(false)) else 'IPMI Module error' }}
      notify: "Send notify on Telegram"
      changed_when: true

- meta: flush_handlers

- name: Accumulate results for report
  set_fact:
    execution_log: "{{ execution_log | default([]) + [{
        'item': item,
        'idrac_res': task_power_idrac | default({'skipped': true}),
        'ipmi_res': task_power_ipmi | default({'skipped': true})
      }] }}"
  delegate_to: localhost